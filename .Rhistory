Tmax_eff <- min(Tmax, Tupper)
Tmin_eff <- max(Tmin, Tbase)
return(round((Tmax_eff - Tmin_eff)^2 / (2 * (Tmax - Tmin)), 3))
}
alpha <- (Tmax - Tmin) / 2
Tmean <- (Tmax + Tmin) / 2
if (method == "sine") {
if (Tmax <= Tbase) return(0)
if (Tmin >= Tbase) return(round(Tmean - Tbase, 3))
x <- (Tbase - Tmean) / alpha |> max(-1) |> min(1)
theta <- acos(x)
return(round((alpha * sin(theta) +
(Tmean - Tbase) * (pi - theta)) / pi, 3))
}
if (method == "sine_upper") {
if (is.null(Tupper)) stop("Tupper required")
if (Tmax <= Tbase || Tmin >= Tupper) return(0)
if (Tupper >= Tmax)
return(degree_days(Tmin, Tmax, Tbase, method = "sine"))
x1 <- (Tbase - Tmean) / alpha |> max(-1) |> min(1)
x2 <- (Tupper - Tmean) / alpha |> max(-1) |> min(1)
t1 <- acos(x1); t2 <- acos(x2)
if (t2 > t1) { tmp <- t1; t1 <- t2; t2 <- tmp }
GD <- (alpha * (sin(t1) - sin(t2)) +
(Tmean - Tbase) * (t2 - t1)) / pi
return(round(max(0, GD), 3))
}
}
############################################################
# UI
############################################################
ui <- fluidPage(
titlePanel("Degree-Day Phenology Calculator"),
sidebarLayout(
sidebarPanel(
fileInput("file", "Upload daily temperature data (CSV)", accept = ".csv"),
tags$small("Required: Tmin, Tmax | Optional: Date"),
hr(),
selectInput("method", "Degree-day method",
choices = c(
"Average" = "average",
"Average (cut)" = "average_cut",
"Triangular" = "triangle",
"Triangular + Tupper" = "triangle_upper",
"Sine" = "sine",
"Sine + Tupper" = "sine_upper"
),
selected = "sine"),
numericInput("tbase", "Base temperature (Tb, °C)", 7.0, 0.1),
checkboxInput("use_upper", "Use upper threshold (Tupper)", FALSE),
numericInput("tupper", "Upper temperature (Tupper, °C)", 30, 0.5),
hr(),
h4("Developmental stage thresholds (cumulative GD)"),
tags$small("Default values are illustrative (e.g. Plutella-like). Adjust for your species."),
numericInput("dd_egg", "Egg", 40),
numericInput("dd_l1", "Larva1 / Ninfa1", 80),
numericInput("dd_l2", "Larva2 / Ninfa2", 120),
numericInput("dd_l3", "Larva3 / Ninfa3", 160),
numericInput("dd_l4", "Larva4 / Ninfa4", 200),
checkboxInput("use_l5", "Include Larva5 / Ninfa5", FALSE),
conditionalPanel(
"input.use_l5",
numericInput("dd_l5", "Larva5 / Ninfa5", 240)
),
checkboxInput("use_l6", "Include Larva6 / Ninfa6", FALSE),
conditionalPanel(
"input.use_l6",
numericInput("dd_l6", "Larva6 / Ninfa6", 280)
),
checkboxInput("use_pupa", "Include Pupa stage", TRUE),
conditionalPanel(
"input.use_pupa",
numericInput("dd_pupa", "Pupa", 320)
),
checkboxInput("use_preov", "Include preoviposition threshold", FALSE),
conditionalPanel(
"input.use_preov",
numericInput("dd_preov", "Preoviposition", 350)
),
hr(),
downloadButton("download_csv", "Download results (CSV)"),
downloadButton("download_png", "Download figure (PNG)")
),
mainPanel(
tabsetPanel(
tabPanel("Table", DTOutput("table")),
tabPanel("Figure", plotOutput("plot", height = 480))
)
)
)
)
############################################################
# SERVER
############################################################
server <- function(input, output) {
thresholds <- reactive({
th <- c(
Egg = input$dd_egg,
"Larva1/Ninfa1" = input$dd_l1,
"Larva2/Ninfa2" = input$dd_l2,
"Larva3/Ninfa3" = input$dd_l3,
"Larva4/Ninfa4" = input$dd_l4
)
if (input$use_l5) th <- c(th, "Larva5/Ninfa5" = input$dd_l5)
if (input$use_l6) th <- c(th, "Larva6/Ninfa6" = input$dd_l6)
if (input$use_pupa) th <- c(th, Pupa = input$dd_pupa)
if (input$use_preov) th <- c(th, Preoviposition = input$dd_preov)
if (any(diff(th) <= 0))
stop("Stage thresholds must be strictly increasing")
th
})
assign_stage <- function(GD, th) {
sapply(GD, function(x) {
i <- which(x < th)[1]
if (is.na(i)) {
if ("Preoviposition" %in% names(th))
"Adult (reproductive)"
else
"Adult"
} else names(th)[i]
})
}
data_proc <- reactive({
if (is.null(input$file)) {
set.seed(1)
n <- 80   # example completes one life cycle
df <- data.frame(
Date = seq.Date(Sys.Date() - n + 1, Sys.Date(), by = "day"),
Tmin = rnorm(n, 12, 2),
Tmax = rnorm(n, 28, 3)
)
} else {
df <- read.csv(input$file$datapath)
}
GD <- mapply(
degree_days,
df$Tmin, df$Tmax,
MoreArgs = list(
Tbase = input$tbase,
Tupper = if (input$use_upper) input$tupper else NULL,
method = input$method
)
)
df$GD <- GD
df$GD_cum <- cumsum(GD)
df$Stage <- assign_stage(df$GD_cum, thresholds())
df
})
output$table <- renderDT({
datatable(
data_proc(),
options = list(
pageLength = 50,
lengthMenu = c(10, 25, 50, 100, 200, -1),
scrollX = TRUE
)
)
})
output$plot <- renderPlot({
df <- data_proc()
th <- thresholds()
idx <- sapply(th, function(v) which(df$GD_cum >= v)[1])
ggplot(df, aes(Date, GD_cum)) +
geom_line() +
geom_point() +
geom_vline(xintercept = df$Date[idx], linetype = 2) +
labs(
y = "Cumulative degree-days",
title = "Thermal phenology based on degree-days",
subtitle = paste("Method:", input$method,
"| Tb =", input$tbase,
if (input$use_upper) paste("| Tupper =", input$tupper))
) +
theme_minimal()
})
output$download_csv <- downloadHandler(
filename = function() "degree_day_results.csv",
content = function(file)
write.csv(data_proc(), file, row.names = FALSE)
)
output$download_png <- downloadHandler(
filename = function() "degree_day_phenology.png",
content = function(file) {
png(file, width = 1800, height = 1200, res = 300)
print(output$plot())
dev.off()
}
)
}
shinyApp(ui, server)
runApp('C:/Users/rosy_/Desktop/app LTB/LTandF/LifeTableandFertility.R')
library(shiny)
library(DT)
library(ggplot2)
CITATION_TEXT <- "Almaraz Valle, V. M., Ramírez Valverde G., Tejeda Reyes M. A., and Rodríguez Maciel J. C. 2026. Degree-Day Phenology Calculator: Modeling Thermal Requirements of Insect Life Stages"
############################################################
# DEGREE-DAY FUNCTION
############################################################
degree_days <- function(Tmin, Tmax, Tbase,
Tupper = NULL,
method = c("average", "average_cut",
"triangle", "triangle_upper",
"sine", "sine_upper")) {
method <- match.arg(method)
if (Tmax < Tmin) { tmp <- Tmin; Tmin <- Tmax; Tmax <- tmp }
# ---- Average methods ----
if (method %in% c("average", "average_cut")) {
GD <- (Tmax + Tmin) / 2 - Tbase
return(round(max(0, GD), 3))
}
# ---- Triangular methods ----
if (method == "triangle") {
if (Tmax <= Tbase) return(0)
if (Tmin >= Tbase) return(round((Tmax + Tmin) / 2 - Tbase, 3))
return(round((Tmax - Tbase)^2 / (2 * (Tmax - Tmin)), 3))
}
if (method == "triangle_upper") {
if (is.null(Tupper)) stop("Tupper required")
if (Tmax <= Tbase || Tmin >= Tupper) return(0)
if (Tupper >= Tmax) return(degree_days(Tmin, Tmax, Tbase, method = "triangle"))
Tmax_eff <- min(Tmax, Tupper)
Tmin_eff <- max(Tmin, Tbase)
return(round((Tmax_eff - Tmin_eff)^2 / (2 * (Tmax - Tmin)), 3))
}
# ---- Sine methods ----
alpha <- (Tmax - Tmin) / 2
Tmean <- (Tmax + Tmin) / 2
if (method == "sine") {
if (Tmax <= Tbase) return(0)
if (Tmin >= Tbase) return(round(Tmean - Tbase, 3))
x <- (Tbase - Tmean) / alpha
x <- max(-1, min(1, x))
theta <- acos(x)
GD <- (alpha * sin(theta) + (Tmean - Tbase) * (pi - theta)) / pi
return(round(GD, 3))
}
# ---- Sine + upper threshold (corrected) ----
if (method == "sine_upper") {
if (is.null(Tupper)) stop("Tupper required")
if (Tmax <= Tbase || Tmin >= Tupper) return(0)
if (Tupper >= Tmax) return(degree_days(Tmin, Tmax, Tbase, method = "sine"))
x1 <- (Tbase - Tmean) / alpha
x2 <- (Tupper - Tmean) / alpha
x1 <- max(-1, min(1, x1))
x2 <- max(-1, min(1, x2))
t1 <- acos(x1)
t2 <- acos(x2)
if (t2 > t1) { tmp <- t1; t1 <- t2; t2 <- tmp }
GD <- (alpha * (sin(t1) - sin(t2)) +
(Tmean - Tbase) * (t2 - t1)) / pi
return(round(max(0, GD), 3))
}
}
############################################################
# UI
############################################################
ui <- fluidPage(
titlePanel("Degree-Day Phenology Calculator"),
sidebarLayout(
sidebarPanel(
fileInput("file", "Upload daily temperature data (CSV)", accept = ".csv"),
tags$small("Required: Tmin, Tmax | Optional: Date"),
hr(),
selectInput("method", "Degree-day method",
choices = c(
"Average" = "average",
"Average (cut)" = "average_cut",
"Triangular" = "triangle",
"Triangular + Tupper" = "triangle_upper",
"Sine" = "sine",
"Sine + Tupper" = "sine_upper"
),
selected = "sine"),
numericInput("tbase", "Base temperature (Tb, °C)", 7.0, 0.1),
checkboxInput("use_upper", "Use upper threshold (Tupper)", FALSE),
numericInput("tupper", "Upper temperature (Tupper, °C)", 30, 0.5),
hr(),
h4("Developmental stage thresholds (cumulative GD)"),
tags$small("Defaults are illustrative (Plutella-like). Adjust for your species."),
numericInput("dd_egg", "Egg", 40),
numericInput("dd_l1", "Larva1 / Ninfa1", 80),
numericInput("dd_l2", "Larva2 / Ninfa2", 120),
numericInput("dd_l3", "Larva3 / Ninfa3", 160),
numericInput("dd_l4", "Larva4 / Ninfa4", 200),
checkboxInput("use_l5", "Include Larva5 / Ninfa5", FALSE),
conditionalPanel(
"input.use_l5",
numericInput("dd_l5", "Larva5 / Ninfa5", 240)
),
checkboxInput("use_l6", "Include Larva6 / Ninfa6", FALSE),
conditionalPanel(
"input.use_l6",
numericInput("dd_l6", "Larva6 / Ninfa6", 280)
),
checkboxInput("use_pupa", "Include Pupa stage", TRUE),
conditionalPanel(
"input.use_pupa",
numericInput("dd_pupa", "Pupa", 320)
),
checkboxInput("use_preov", "Include preoviposition threshold", FALSE),
conditionalPanel(
"input.use_preov",
numericInput("dd_preov", "Preoviposition", 350)
),
hr(),
downloadButton("download_csv", "Download results (CSV)"),
downloadButton("download_png", "Download figure (PNG)")
),
mainPanel(
tabsetPanel(
tabPanel(
"Table",
DTOutput("table"),
tags$div(style="margin-top:10px; font-size:12px; color:#444;",
CITATION_TEXT)
),
tabPanel(
"Figure",
plotOutput("plot", height = 480),
tags$div(style="margin-top:10px; font-size:12px; color:#444;",
CITATION_TEXT)
)
)
)
)
)
############################################################
# SERVER
############################################################
server <- function(input, output, session) {
thresholds <- reactive({
th <- c(
"Egg" = input$dd_egg,
"Larva1/Ninfa1" = input$dd_l1,
"Larva2/Ninfa2" = input$dd_l2,
"Larva3/Ninfa3" = input$dd_l3,
"Larva4/Ninfa4" = input$dd_l4
)
if (input$use_l5) th <- c(th, "Larva5/Ninfa5" = input$dd_l5)
if (input$use_l6) th <- c(th, "Larva6/Ninfa6" = input$dd_l6)
if (input$use_pupa) th <- c(th, "Pupa" = input$dd_pupa)
if (input$use_preov) th <- c(th, "Preoviposition" = input$dd_preov)
if (any(diff(as.numeric(th)) <= 0))
stop("Stage thresholds must be strictly increasing")
th
})
assign_stage <- function(GD_cum, th) {
sapply(GD_cum, function(x) {
i <- which(x < th)[1]
if (is.na(i)) {
if ("Preoviposition" %in% names(th))
"Adult (reproductive)"
else
"Adult"
} else names(th)[i]
})
}
data_proc <- reactive({
if (is.null(input$file)) {
# Example data: ONLY 30 days (enough to show progress; user can upload up to 200+ rows)
set.seed(1)
n <- 30
df <- data.frame(
Date = seq.Date(Sys.Date() - n + 1, Sys.Date(), by = "day"),
Tmin = round(rnorm(n, 12, 2), 1),
Tmax = round(rnorm(n, 28, 3), 1)
)
df$Tmax <- pmax(df$Tmax, df$Tmin + 1.5) # ensure Tmax > Tmin
} else {
df <- read.csv(input$file$datapath, stringsAsFactors = FALSE)
# If user has more than 200 rows, keep all; table will allow viewing 200 via menu.
# Ensure numeric:
df$Tmin <- suppressWarnings(as.numeric(df$Tmin))
df$Tmax <- suppressWarnings(as.numeric(df$Tmax))
if ("Date" %in% names(df)) {
df$Date <- tryCatch(as.Date(df$Date), error = function(e) df$Date)
}
}
GD <- mapply(
degree_days,
df$Tmin, df$Tmax,
MoreArgs = list(
Tbase = input$tbase,
Tupper = if (input$use_upper) input$tupper else NULL,
method = input$method
)
)
df$GD <- as.numeric(GD)
df$GD_cum <- cumsum(ifelse(is.na(df$GD), 0, df$GD))
th <- thresholds()
df$Stage <- assign_stage(df$GD_cum, th)
df
})
# Helper: compute label positions (one label per stage segment)
stage_labels_df <- reactive({
df <- data_proc()
if (!("Date" %in% names(df))) {
df$Date <- seq_len(nrow(df))
}
# Run-length encoding of stages
r <- rle(as.character(df$Stage))
ends <- cumsum(r$lengths)
starts <- ends - r$lengths + 1
mids <- floor((starts + ends) / 2)
data.frame(
Date = df$Date[mids],
GD_cum = df$GD_cum[mids],
Stage = r$values,
stringsAsFactors = FALSE
)
})
output$table <- renderDT({
datatable(
data_proc(),
options = list(
pageLength = 20,                       # show up to 20 entries by default
lengthMenu = list(
c(10, 20, 50, 100, 200, -1),
c("10", "20", "50", "100", "200", "All")
),
scrollX = TRUE
),
rownames = FALSE
)
})
output$plot <- renderPlot({
df <- data_proc()
labs_df <- stage_labels_df()
# ensure x is Date-like or index; ggplot handles both
ggplot(df, aes(x = Date, y = GD_cum)) +
geom_line(linewidth = 1) +
geom_point(size = 2) +
geom_text(
data = labs_df,
aes(x = Date, y = GD_cum, label = Stage),
vjust = -0.6,
size = 3.6,
inherit.aes = FALSE
) +
labs(
x = if ("Date" %in% names(df)) "Date" else "Index",
y = "Cumulative degree-days",
title = "Thermal phenology based on degree-days",
subtitle = paste(
"Method:", input$method,
"| Tb =", input$tbase,
if (input$use_upper) paste("| Tupper =", input$tupper) else ""
)
) +
theme_minimal(base_size = 13)
})
output$download_csv <- downloadHandler(
filename = function() "degree_day_results.csv",
content = function(file) {
write.csv(data_proc(), file, row.names = FALSE)
}
)
# Save plot as PNG (300 dpi)
output$download_png <- downloadHandler(
filename = function() "degree_day_phenology.png",
content = function(file) {
png(file, width = 1800, height = 1200, res = 300)
df <- data_proc()
labs_df <- stage_labels_df()
p <- ggplot(df, aes(x = Date, y = GD_cum)) +
geom_line(linewidth = 1) +
geom_point(size = 2) +
geom_text(
data = labs_df,
aes(x = Date, y = GD_cum, label = Stage),
vjust = -0.6,
size = 3.6,
inherit.aes = FALSE
) +
labs(
x = if ("Date" %in% names(df)) "Date" else "Index",
y = "Cumulative degree-days",
title = "Thermal phenology based on degree-days",
subtitle = paste(
"Method:", input$method,
"| Tb =", input$tbase,
if (input$use_upper) paste("| Tupper =", input$tupper) else ""
)
) +
theme_minimal(base_size = 13)
print(p)
dev.off()
}
)
}
shinyApp(ui, server)
library(shiny); runApp('C:/Users/rosy_/Desktop/app LTB/LTandF/LifeTableandFertility.R')
runApp('C:/Users/rosy_/Desktop/app LTB/DDFC/DDFC.R')
shiny::runApp('C:/Users/rosy_/Desktop/app LTB')
runApp('C:/Users/rosy_/Desktop/app LTB/LTandF/LifeTableandFertility.R')
shiny::runApp('C:/Users/rosy_/Desktop/app LTB/LifeTableBuilder/inst/shiny')
shiny::runApp('C:/Users/rosy_/Desktop/app LTB/LifeTableBuilder/inst/shiny')
runApp('C:/Users/rosy_/Desktop/app LTB/LifeTableBuilder/inst/shiny')
setwd("C:/Users/rosy_/Desktop/app LTB/LifeTableFertility")
install.packages("roxygen2")
install.packages("devtools")
install.packages("roxygen2")
install.packages("devtools")
install.packages("devtools")
setwd("C:/Users/rosy_/Desktop/app LTB/LifeTableFertility")
getwd()
devtools::document()
devtools::document()
devtools::document()
devtools::document()
devtools::document()
devtools::check()
